# sample policy 1
-- Yêu cầu 8: Trưởng phòng được phép đọc thông tin chi tiêu của dự án trong phòng ban mình quản lý. Với những dự án không thuộc phòng ban của mình
--             các trưởng phòng được phép xem thông tin chi tiêu nhưng không được phép xem số tiền cụ thể (VPD)--
create or replace view ThongTinChiTieu_PhongBan
as
select maChiTieu, tenChiTieu, soTien, duAn, truongPhong
from (ChiTieu join DuAn on (ChiTieu.duAn = DuAn.maDA))
join PhongBan on DuAn.phongChuTri = PhongBan.maPhong;

grant select on ThongTinChiTieu_PhongBan to TRUONGPHONG;

create or replace function xemSoTien (
p_schema varchar2, p_obj varchar2)
return varchar2
as
  user varchar2(100);
begin
  user := sys_context('userenv', 'session_user');
  return 'truongPhong = lower('''||user||''')';
end;

begin
dbms_rls.add_policy (
  object_schema => 'sys',
  object_name => 'ThongTinChiTieu_PhongBan',
  policy_name => 'xemSoTien_Phong',
  function_schema => 'sys',
  policy_function => 'xemSoTien',
  sec_relevant_cols => 'soTien', sec_relevant_cols_opt => dbms_rls.ALL_ROWS);
end;
